
set shell := ["bash", "-eu", "-o", "pipefail", "-c"]

# ==== 기본 설정 ====

default: build

BUILD_DIR := 'build'

# init (CMake 설정 + compile_commands.json 심볼릭 링크)
init:
    mkdir -p {{BUILD_DIR}}
    cmake -S . -B {{BUILD_DIR}} \
        -DCMAKE_BUILD_TYPE="${BUILD_TYPE:-Debug}" \
        -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
        ${CXX:+-DCMAKE_CXX_COMPILER=$$CXX} \
        ${GEN:+-G "$$GEN"}
    ln -sfn cpp_http/{{BUILD_DIR}}/compile_commands.json ../compile_commands.json
    echo "✅ compile_commands.json ready"

# 빌드
build:
    cmake --build {{BUILD_DIR}} -j

# 실행
run: build
    ./{{BUILD_DIR}}/tiny-server

# 클린 (빌드 산출물 제거)
clean:
    cmake --build {{BUILD_DIR}} --target clean || true

# 완전 초기화
distclean:
    rm -rf {{BUILD_DIR}}
